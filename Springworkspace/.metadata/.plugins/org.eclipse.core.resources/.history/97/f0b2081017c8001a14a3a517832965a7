package com.withpet.app;

import java.io.File;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartRequest;

import album.AlbumServiceImpl;
import album.AlbumVO;
import pet.PetVO;

@Controller
public class AlbumController {
	
@Autowired private AlbumServiceImpl service;
	
	//DB에서 정보 가져오기
	@RequestMapping("/albumList")
	public String list(String a_pet, Model model) {
		model.addAttribute("list", service.album_list(a_pet));
		return "album/list";
	}
	
	//앨범에 사진 업로드
	@RequestMapping(value = "/albumInsert", produces = "text/html; charset=utf-8")
	public String insert(HttpServletRequest request, Model model) {
		AlbumVO vo = new AlbumVO();
		vo.setA_pet( Integer.parseInt(request.getParameter("a_pet")));
		vo.setA_title((String) request.getParameter("a_title"));
		if(request.getParameter("a_content") != null) {
			vo.setA_content((String) request.getParameter("a_content"));
		}
		
		String dbImgPath = null;
		if(request.getParameter("imageDbPath") != null) {
			dbImgPath = (String) request.getParameter("imageDbPath");
			vo.setP_pic(dbImgPath);
		}
			
		MultipartFile file = null;
		try {
			MultipartRequest multi = (MultipartRequest)request;
			file = multi.getFile("image");
		} catch(Exception e) {
			System.out.println("파일이 첨부되지 않음.");
		}
		
		if(file != null) {
			String fileName = dbImgPath;
			// 디렉토리 존재하지 않으면 생성
			common.makeDir(request, "pet");	
				
			if(file.getSize() > 0){			
				String realImgPath = request.getSession().getServletContext()
						.getRealPath("/resources/upload/pet/");
				
				System.out.println( fileName + " : " + realImgPath);
				System.out.println( "fileSize : " + file.getSize());					
												
			 	try {
			 		// 이미지파일 저장
					file.transferTo(new File(realImgPath, fileName));						
				} catch (Exception e) {
					e.printStackTrace();
				} 
									
			}else{
				fileName = "FileFail.jpg";
				String realImgPath = request.getSession().getServletContext()
						.getRealPath("/resources/upload/pet/" + fileName);
				System.out.println(fileName + " : " + realImgPath);
			}			
		}
		
		int succ = service.pet_insert(vo);
		model.addAttribute("result", String.valueOf(succ));
		
		return "pet/result";
	}
}